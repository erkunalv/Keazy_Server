================================================================================
                         KEAZY - PROJECT ARCHITECTURE
================================================================================

DIRECTORY STRUCTURE
================================================================================

Project_3/
â”œâ”€â”€ .env.example (template - rename to .env)
â”œâ”€â”€ .env.development.example
â”œâ”€â”€ .env.production.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ prometheus.yml
â”œâ”€â”€ promtail-config.yml
â”‚
â”œâ”€â”€ postman/
â”‚   â””â”€â”€ Keazy.postman_collection.json
â”‚
â”œâ”€â”€ keazy-admin/                # React Frontend (Vite + MUI)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/                # API client hooks (React Query)
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard.js    # Dashboard/logs/services API
â”‚   â”‚   â”‚   â””â”€â”€ ratings.js      # â­ Rating submission & retrieval API
â”‚   â”‚   â”œâ”€â”€ components/         # Reusable UI components
â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardLayout.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RatingDialog.jsx    # â­ Star rating modal component
â”‚   â”‚   â”‚   â””â”€â”€ LocationPicker.jsx  # ğŸ—ºï¸ Interactive map for geo search
â”‚   â”‚   â”œâ”€â”€ pages/              # Route pages
â”‚   â”‚   â”‚   â”œâ”€â”€ AnalyticsDashboard.jsx # Charts + Provider Ratings
â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardPage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProvidersPage.jsx      # â­ Provider management page
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ providers/          # Context providers (Toast, Auth)
â”‚   â””â”€â”€ vite.config.js
â”‚
â”œâ”€â”€ keazy-backend/              # Node.js/Express API Server
â”‚   â”œâ”€â”€ routes/                 # API endpoints
â”‚   â”‚   â”œâ”€â”€ query.js            # Main query processing pipeline
â”‚   â”‚   â”œâ”€â”€ dashboard.js        # Admin CRUD + analytics operations
â”‚   â”‚   â”œâ”€â”€ providers.js        # â­ Provider registration & listing
â”‚   â”‚   â””â”€â”€ ratings.js          # â­ Rating submission & stats
â”‚   â”œâ”€â”€ services/               # Business logic
â”‚   â”‚   â”œâ”€â”€ entities.js         # Rule-based service matching
â”‚   â”‚   â”œâ”€â”€ intentModel.js      # ML service client
â”‚   â”‚   â””â”€â”€ urgency.js          # Urgency detection
â”‚   â”œâ”€â”€ models/                 # Mongoose schemas
â”‚   â”‚   â”œâ”€â”€ provider.js
â”‚   â”‚   â”œâ”€â”€ rating.js           # â­ Rating schema
â”‚   â”‚   â”œâ”€â”€ slot.js
â”‚   â”‚   â”œâ”€â”€ user.js
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ seed/                   # Database seed scripts
â”‚   â”œâ”€â”€ simulators/             # â­ Test data generators
â”‚   â”‚   â””â”€â”€ providerRegistrationSimulator.js
â”‚   â””â”€â”€ entities/
â”‚       â””â”€â”€ synonyms.json       # Fallback keyword mappings
â”‚
â”œâ”€â”€ ml-service/                 # Python ML Service (Flask)
â”‚   â”œâ”€â”€ app.py                  # REST API + prediction endpoint
â”‚   â”œâ”€â”€ train_model.py          # Model training script
â”‚   â””â”€â”€ models/                 # Saved model artifacts (.pkl)
â”‚
â””â”€â”€ postman/                    # API testing collection


================================================================================
                            SYSTEM ARCHITECTURE          
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              EXTERNAL CLIENT                                â”‚
â”‚                    (Mobile App / Web App / Voice Interface)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ POST /query
                                      â”‚ { query_text, user_id, city }
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           KEAZY BACKEND (Node.js)                           â”‚
â”‚                              Port: 3000                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚      â”‚   Query       â”€â”€â”€â–¶   Service     â”€â”€â”€â–¶    Provider   â”‚               â”‚
â”‚      â”‚   Router     â”‚    â”‚   Matcher    â”‚    â”‚   Matcher    â”‚               â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚             â”‚                   â”‚                    â”‚                      â”‚
â”‚             â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”             â”‚                      â”‚
â”‚             â”‚            â–¼             â–¼             â”‚                      â”‚
â”‚             â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                      â”‚
â”‚             â”‚       â”‚  Rule    â”‚  â”‚   ML     â”‚       â”‚                      â”‚
â”‚             â”‚       â”‚  Engine  â”‚  â”‚ Fallback â”‚       â”‚                      â”‚
â”‚             â”‚       â”‚(synonyms)â”‚  â”‚ (HTTP)   â”‚       â”‚                      â”‚
â”‚             â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚                      â”‚
â”‚             â”‚                          â”‚             â”‚                      â”‚
â”‚             â–¼                          â–¼             â–¼                      â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚       â”‚                    MongoDB Driver                    â”‚              â”‚
â”‚       â”‚         (Users, Queries, Providers, Slots)           â”‚              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                   â”‚
                    â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ML SERVICE (Python)          â”‚     â”‚         MONGODB               â”‚
â”‚          Port: 5000               â”‚     â”‚        Port: 27017            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                   â”‚     â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  Collections:                 â”‚
â”‚  â”‚   /predict Endpoint         â”‚  â”‚     â”‚  â”œâ”€â”€ users                    â”‚
â”‚  â”‚   - TF-IDF Vectorizer       â”‚  â”‚     â”‚  â”œâ”€â”€ queries                  â”‚
â”‚  â”‚   - LogisticRegression      â”‚  â”‚     â”‚  â”œâ”€â”€ services                 â”‚
â”‚  â”‚   - Returns: service,       â”‚  â”‚     â”‚  â”œâ”€â”€ providers                â”‚
â”‚  â”‚     confidence              â”‚  â”‚     â”‚  â”œâ”€â”€ slots                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â”œâ”€â”€ ml_logs                  â”‚
â”‚                                   â”‚     â”‚  â””â”€â”€ retrainhistories         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚                               â”‚
â”‚  â”‚   /retrain Endpoint         â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚   - Fetches approved        â”‚  â”‚
â”‚  â”‚     queries from DB         â”‚  â”‚
â”‚  â”‚   - Retrains model          â”‚  â”‚
â”‚  â”‚   - Hot-reloads             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
                          QUERY PROCESSING PIPELINE
================================================================================

Input: { 
  query_text: "fix my fan urgently", 
  user_id: "usr123", 
  state: "Delhi",           // Optional: State filter
  city: "Delhi",            // Optional: City filter
  lat: 28.6315,             // Optional: Latitude for geo search
  lng: 77.2197,             // Optional: Longitude for geo search
  radius_km: 10             // Optional: Search radius (default: 10km)
}

Step 1: USER TRACKING
â”œâ”€â”€ Upsert user in DB (auto-create if new)
â”œâ”€â”€ Increment total_queries counter
â””â”€â”€ Update last_query_at timestamp

Step 2: SERVICE DETECTION (Two-Phase)
â”‚
â”œâ”€â”€ Phase A: Rule-Based Matching (Fast Path)
â”‚   â”œâ”€â”€ Load synonyms from DB (5-min cache) or fallback JSON
â”‚   â”œâ”€â”€ Keyword scan: "fan" found â†’ service = "electrician"
â”‚   â”œâ”€â”€ Confidence: 0.95 (rule-based)
â”‚   â””â”€â”€ Source: "rule"
â”‚
â””â”€â”€ Phase B: ML Fallback (if rules fail)
    â”œâ”€â”€ POST to ML service /predict
    â”œâ”€â”€ TF-IDF vectorization + LogisticRegression
    â”œâ”€â”€ Returns predicted_service + confidence
    â””â”€â”€ Source: "ml"

Step 3: PROVIDER MATCHING (â­ Hierarchical Geo Search)
â”‚
â”œâ”€â”€ Level 1: STATE Filter (if provided)
â”‚   â””â”€â”€ filter.state = /^Delhi$/i
â”‚
â”œâ”€â”€ Level 2: CITY Filter (if provided)
â”‚   â””â”€â”€ filter.city = /^Delhi$/i
â”‚
â”œâ”€â”€ Level 3: GEOLOCATION Radius (if lat/lng provided)
â”‚   â”œâ”€â”€ Uses MongoDB $geoNear aggregation
â”‚   â”œâ”€â”€ Searches within radius_km from [lng, lat]
â”‚   â”œâ”€â”€ Returns distance_m and distance_km per provider
â”‚   â””â”€â”€ Sorts by distance (closest first)
â”‚
â”œâ”€â”€ Scoring: verified + rating + jobs_completed + available_now + distance
â”‚
â””â”€â”€ Fallback Chain:
    â”œâ”€â”€ 1st: Remove geo filter, keep state + city
    â”œâ”€â”€ 2nd: Remove city filter, keep state
    â””â”€â”€ 3rd: Service only (all locations)

Step 4: SLOT AGGREGATION
â”œâ”€â”€ For each provider, fetch available slots
â”œâ”€â”€ Filter: date >= today, available = true
â”œâ”€â”€ Sort: date ASC, time ASC
â””â”€â”€ Limit: 5 slots per provider

Step 5: RESPONSE CONSTRUCTION
â”œâ”€â”€ Build "business cards" with provider + slots + distance
â”œâ”€â”€ Log query to DB with latency_ms
â””â”€â”€ Return structured JSON response

Output:
{
  "success": true,
  "query": {
    "detected_service": "electrician",
    "confidence": 95,
    "source": "rule",
    "urgency": "high"
  },
  "location": {
    "state": "Delhi",
    "city": "Delhi",
    "geo": { "lat": 28.6315, "lng": 77.2197, "radius_km": 10 },
    "search_method": "geo"  // "geo" | "standard" | "fallback-*"
  },
  "business_cards": [
    {
      "name": "Brilliant Electrician",
      "contact": "9876543217",
      "rating": 4.6,
      "distance_km": 2.5,
      "next_available_slots": [
        { "slot_id": "...", "date": "2026-01-01", "time": "09:00" }
      ]
    }
  ],
  "meta": { "latency_ms": 45, "log_id": "..." }
}


================================================================================
                         DATA FLOW DIAGRAMS
================================================================================

1. QUERY FLOW (User â†’ Response)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Client                Backend              ML Service           MongoDB
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚â”€â”€â”€ POST /query â”€â”€â”€â”€â–¶â”‚                      â”‚                  â”‚
    â”‚                     â”‚â”€â”€ upsert user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€ user doc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚                     â”‚â”€â”€ rule match â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
    â”‚                     â”‚   (cache/DB)         â”‚                   â”‚
    â”‚                     â”‚â—€â”€â”€ service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚                     â”‚   [if no rule match] â”‚                   â”‚
    â”‚                     â”‚â”€â”€â”€â”€â”€ /predict â”€â”€â”€â”€â”€â”€â–¶â”‚                  â”‚
    â”‚                     â”‚â—€â”€â”€ prediction â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚                     â”‚â”€â”€ find providers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€ providers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚                     â”‚â”€â”€ find slots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€ slots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚                     â”‚â”€â”€ log query â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚â—€â”€â”€ business cards â”€â”€â”‚                     â”‚                   â”‚


2. BOOKING FLOW (Slot Selection â†’ Confirmation)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Client                Backend                          MongoDB
    â”‚                     â”‚                                 â”‚
    â”‚â”€ POST /query/book â”€â–¶â”‚                                 â”‚
    â”‚   { slot_id,        â”‚                                 â”‚
    â”‚     user_id }       â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ atomic update slot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚   (available=false,             â”‚
    â”‚                     â”‚    booked_by=user_id,           â”‚
    â”‚                     â”‚    status='booked')             â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€ updated slot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                     â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ update user stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚   (total_bookings++,            â”‚
    â”‚                     â”‚    last_booking_at=now)         â”‚
    â”‚                     â”‚                                 â”‚
    â”‚â—€â”€â”€ booking confirm â”€â”‚                                 â”‚


3. RETRAIN FLOW (Admin Trigger â†’ Model Update)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Admin UI              Backend              ML Service           MongoDB
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚â”€ POST /retrain â”€â”€â”€â”€â–¶â”‚                      â”‚                   â”‚
    â”‚                     â”‚â”€â”€â”€ /retrain â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
    â”‚                     â”‚                      â”‚â”€â”€ fetch approved â”€â–¶â”‚
    â”‚                     â”‚                      â”‚   queries          â”‚
    â”‚                     â”‚                      â”‚â—€â”€â”€â”€ training data â”€â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚                     â”‚                      â”‚â”€â”€ train model     â”‚
    â”‚                     â”‚                      â”‚   (TF-IDF +       â”‚
    â”‚                     â”‚                      â”‚    LogReg)        â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚                     â”‚                      â”‚â”€â”€ save .pkl       â”‚
    â”‚                     â”‚                      â”‚â”€â”€ hot reload      â”‚
    â”‚                     â”‚â—€â”€â”€ success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                     â”‚                      â”‚                   â”‚
    â”‚                     â”‚â”€â”€ log retrain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚â—€â”€â”€ retrain result â”€â”€â”‚                      â”‚                   â”‚


4. PROVIDER REGISTRATION FLOW (Admin â†’ Database)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Admin UI              Backend                          MongoDB
    â”‚                     â”‚                                 â”‚
    â”‚â”€ POST /providers   â–¶â”‚                                 â”‚
    â”‚   /register         â”‚                                 â”‚
    â”‚   { name, service,  â”‚                                 â”‚
    â”‚     contact, slots, â”‚                                 â”‚
    â”‚     voice_intro }   â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ validate required â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚   fields (name,service,contact) â”‚
    â”‚                     â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ create provider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€ provider doc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                     â”‚                                 â”‚
    â”‚â—€â”€â”€ provider_id â”€â”€â”€â”€â”‚                                 â”‚

  Simulator Flow (for testing):
    â”‚                     â”‚                                 â”‚
    â”‚â”€ POST /providers   â–¶â”‚                                 â”‚
    â”‚   /simulate?count=5 â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ generate random providers â”€â”€â”€â–¶â”‚
    â”‚                     â”‚   (names, services, contacts)   â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€ created providers â”€â”€â”€â”€â”€â”‚
    â”‚â—€â”€â”€ provider list â”€â”€â”‚                                 â”‚


5. RATING SUBMISSION FLOW (User â†’ Provider Stats Update)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Admin UI              Backend                          MongoDB
    â”‚                     â”‚                                 â”‚
    â”‚â”€ POST /ratings/add â–¶â”‚                                 â”‚
    â”‚   { booking_id,     â”‚                                 â”‚
    â”‚     provider_id,    â”‚                                 â”‚
    â”‚     rating: 1-5,    â”‚                                 â”‚
    â”‚     comment }       â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ validate rating (1-5) â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ save rating â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€ rating doc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                     â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ calculate avg rating â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚   (aggregate all provider       â”‚
    â”‚                     â”‚    ratings)                     â”‚
    â”‚                     â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ update provider.rating â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€ updated provider â”€â”€â”€â”€â”€â”€â”‚
    â”‚                     â”‚                                 â”‚
    â”‚â—€â”€â”€ rating + stats â”€â”‚                                 â”‚

  Get Ratings with Stats:
    â”‚                     â”‚                                 â”‚
    â”‚â”€ GET /ratings/     â–¶â”‚                                 â”‚
    â”‚   provider/:id      â”‚                                 â”‚
    â”‚                     â”‚â”€â”€ aggregate ratings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                     â”‚   { avg, distribution,          â”‚
    â”‚                     â”‚     count, paginated list }     â”‚
    â”‚                     â”‚â—€â”€â”€â”€â”€â”€â”€â”€ stats + ratings â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚â—€â”€â”€ stats response â”€â”‚                                 â”‚


================================================================================
                           DATABASE SCHEMA
================================================================================

USERS COLLECTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  user_id: String (unique, indexed),
  phone: String,
  name: String,
  city: String,
  area: String,
  preferences: { language: String, preferred_services: [String] },
  total_queries: Number,
  total_bookings: Number,
  last_query_at: Date,
  last_booking_at: Date,
  verified: Boolean,
  active: Boolean
}

SERVICES COLLECTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  name: String (indexed),           // "electrician", "plumber"
  synonyms: [String],               // ["fan", "light", "wiring"]
  description: String,
  base_price_hint: Number,
  enabled: Boolean
}

PROVIDERS COLLECTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  provider_id: String,
  name: String,
  service: String (indexed),        // Links to service.name
  contact: String,
  hourly_rate: Number,
  
  // â­ Hierarchical Location Fields
  state: String (indexed),          // "Uttar Pradesh", "Delhi"
  city: String (indexed),           // "Aligarh", "Lucknow"
  area: String,                     // "Mangal Vihar", "Hazratganj"
  district: String,
  pincode: String,
  
  // â­ GeoJSON Location for Radius Search
  location: {
    type: String ('Point'),
    coordinates: [Number, Number]   // [longitude, latitude]
  },
  geo_accuracy_m: Number,           // GPS accuracy in meters
  
  rating: Number,
  verified: Boolean,
  available_now: Boolean,
  response_time_min: Number,
  jobs_completed_30d: Number
}

// Indexes for geo search:
// - { service: 1, city: 1, area: 1 }
// - { location: '2dsphere' } (sparse)

SLOTS COLLECTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  provider_id: ObjectId (ref: Provider),
  date: String,                     // "2026-01-01"
  time: String,                     // "09:00"
  duration_min: Number,
  service_name: String,             // Denormalized for fast queries
  available: Boolean,
  status: Enum ['available', 'booked', 'completed', 'cancelled'],
  booked_by: String,                // user_id
  booked_at: Date,
  booking_notes: String
}

QUERIES COLLECTION (Logs)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  user_id: String,
  query_text: String,
  normalized_service: String,       // Detected service
  assigned_service: String,         // Admin-corrected service
  confidence: Number,
  source: Enum ['rule', 'ml'],
  urgency: Enum ['low', 'normal', 'high'],
  latency_ms: Number,
  location: String,
  matched_providers: [ObjectId],
  approved_for_training: Boolean,   // Admin approval for ML training
  timestamp: Date
}

RATINGS COLLECTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  booking_id: String,               // Reference to booking/slot
  provider_id: ObjectId (ref: Provider, indexed),
  rating: Number (1-5, required),   // Star rating
  comment: String,                  // Optional feedback
  created_at: Date (indexed)        // Auto-timestamped
}


================================================================================
                         API ENDPOINTS REFERENCE
================================================================================

QUERY ROUTES (/query)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
POST /query              Main query processing pipeline (supports geo params)
POST /query/book         Book a slot
POST /query/cancel       Cancel a booking
GET  /query/bookings/:id Get user's bookings
POST /query/feedback     Submit feedback on prediction

PROVIDER ROUTES (/providers)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
POST /providers/register  Register new provider with geo (name, service, contact + lat/lng)
GET  /providers           List providers (paginated: ?page=1&limit=10)
GET  /providers/:id       Get provider by ID with full profile

â­ GEO SEARCH ROUTES (/providers)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GET  /providers/nearby    Find nearby providers with distance calculation
                          Params: lat, lng (required), radius_km, service, state, city, limit
                          Returns: providers sorted by distance with distance_m, distance_km
                          Example: /providers/nearby?lat=27.8974&lng=78.0880&radius_km=5&service=electrician

GET  /providers/near      Simple $near search (legacy)
                          Params: service, lat, lng (required), maxKm, limit
                          Example: /providers/near?service=plumber&lat=26.8467&lng=80.9462&maxKm=10

RATING ROUTES (/ratings)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
POST /ratings/add                 Submit rating (booking_id, provider_id, rating 1-5, comment)
GET  /ratings/provider/:id        Get provider ratings with stats (avg, distribution)

DASHBOARD ROUTES (/dashboard)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GET  /dashboard/logs              Recent query logs
GET  /dashboard/stats             System statistics
GET  /dashboard/services          List services with synonyms
POST /dashboard/services          Create service
PUT  /dashboard/services/:id      Update service (clears synonym cache)
GET  /dashboard/users             List users
GET  /dashboard/users/:id         User profile + query history
GET  /dashboard/slots             List slots (filterable)
POST /dashboard/retrain           Trigger ML model retraining
GET  /dashboard/retrain/history   Retrain history
GET  /dashboard/model/status      Current model status
POST /dashboard/logs/:id/approve  Approve log for training
POST /dashboard/logs/:id/assign   Correct service assignment

ANALYTICS ROUTES (/dashboard/analytics)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GET  /dashboard/analytics/corrections         Service correction stats
GET  /dashboard/analytics/retrain-impact      Retrain impact metrics
GET  /dashboard/analytics/provider-performance Provider stats with ratings
GET  /dashboard/analytics/latency-trends      Query latency trends

ML SERVICE ROUTES (Port 5000)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GET  /health     Health check
POST /predict    Service prediction (requires X-API-Key header)
POST /retrain    Retrain model from approved logs
GET  /metrics    Prometheus metrics


================================================================================
                         CONFIGURATION
================================================================================

ENVIRONMENT VARIABLES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Backend (.env):
  PORT=3000
  MONGO_URI=mongodb://mongodb:27017/keazy
  ML_SERVICE_URL=http://mlservice:5000
  ML_API_KEY=your-secret-key

ML Service (.env):
  ML_PORT=5000
  ML_MONGO_URI=mongodb://mongodb:27017/keazy
  ML_API_KEY=your-secret-key
  ML_CORS_ORIGIN=*

Frontend (.env):
  VITE_API_BASE=http://localhost:3000


================================================================================
                         DOCKER SERVICES
================================================================================

Service         Port    Description
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mongodb         27017   MongoDB database
backend         3000    Node.js API server
mlservice       5000    Python ML service
grafana         3001    Monitoring dashboard
prometheus      9090    Metrics collection
loki            3100    Log aggregation
promtail        -       Log shipper

MongoDB Collections:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€â”€ users           User profiles & query history
â”œâ”€â”€ services        Service definitions & synonyms
â”œâ”€â”€ providers       Provider profiles & ratings
â”œâ”€â”€ slots           Booking slots
â”œâ”€â”€ queries         Query logs for ML training
â”œâ”€â”€ ratings         â­ Provider ratings & feedback
â”œâ”€â”€ ml_logs         ML prediction logs
â””â”€â”€ retrainhistories Model retrain history


================================================================================
                         GIT TRACKING STATUS
================================================================================

Tracked in Git: âœ…
- All source code (.js, .jsx, .py)
- Configuration files
- Seed data & templates
- Documentation & API collections

NOT Tracked (see .gitignore): âŒ
- node_modules/ (install with npm install / yarn)
- logs/ (generated at runtime)
- *.pkl files (ML models - too large)
- .env files (use .env.example as template)
- __pycache__/ (Python cache)
- grafana-data/ (database files)
- package-lock.json (regenerated)


================================================================================
                         FRONTEND ROUTES (React Router)
================================================================================

Route                   Component               Description
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/                       DashboardPage           Main dashboard with query logs
/analytics              AnalyticsDashboard      Charts: corrections, latency, ratings
/providers              ProvidersPage           â­ Provider list, register, simulate, rate
/predict                PredictPage             ğŸ—ºï¸ Voice Query Simulator with Location Picker
/services               (via DashboardPage)     Service management with synonyms
/users                  (planned)               User management


================================================================================
                      LOCATION PICKER COMPONENT (Production-Ready)
================================================================================

File: keazy-admin/src/components/LocationPicker.jsx

PURPOSE:
Interactive map-based location selector that simulates how a mobile app would 
capture user GPS coordinates and send them to the geo search API.

FEATURES:
- ğŸ—ºï¸ Interactive Leaflet map with click-to-select
- ğŸ“ 8 preset Indian locations for quick testing
- ğŸŒ Reverse geocoding via OpenStreetMap Nominatim (free API)
- ğŸ“¡ Browser GPS detection ("Use My Location")
- âœï¸ Manual coordinate input with validation
- ğŸ“ Adjustable search radius slider (1-50km) with visual circle
- ğŸ”„ Auto-detects state/city from clicked coordinates

PRESET LOCATIONS:
- Aligarh (AMU Campus, Mangal Vihar)
- Lucknow (Hazratganj)
- Delhi (Connaught Place, Karol Bagh)
- Noida (Sector 62)
- Agra (Taj Ganj)
- Gurgaon (DLF)

PROPS:
  onLocationChange  - Callback: { lat, lng, state, city, area, radius_km }
  initialLocation   - Optional initial position
  showRadius        - Show radius circle on map (default: true)
  compact           - Collapsible mode for smaller screens

DEPENDENCIES:
  npm install leaflet react-leaflet
  import 'leaflet/dist/leaflet.css' in main.jsx


================================================================================
                         SETUP INSTRUCTIONS
================================================================================

1. Clone repository
2. Copy .env.example files to .env and configure
3. Run: npm install (in keazy-admin and keazy-backend)
4. Run: docker compose up -d
5. Seed database: docker exec project_3-backend-1 node seed/seedAll.js
6. Access:
   - Frontend: http://localhost:5173
   - Backend API: http://localhost:3000
   - Grafana: http://localhost:3001

